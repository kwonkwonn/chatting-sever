<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì±„íŒ…</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, sans-serif;
        background: #f0f0f0;
        height: 100vh;
      }

      .app {
        display: flex;
        height: 100vh;
      }

      /* ì‚¬ì´ë“œë°” */
      .sidebar {
        width: 280px;
        background: white;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #ddd;
      }

      .sidebar-header h1 {
        font-size: 20px;
        margin-bottom: 15px;
      }

      .sidebar-header button {
        width: 100%;
        padding: 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      .sidebar-header button:hover {
        background: #0056b3;
      }

      /* ì±„íŒ…ë°© ëª©ë¡ */
      .room-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .room-item {
        padding: 15px;
        margin-bottom: 5px;
        background: #f9f9f9;
        border-radius: 8px;
        cursor: pointer;
      }

      .room-item:hover {
        background: #e9e9e9;
      }

      .room-item.active {
        background: #007bff;
        color: white;
      }

      /* ì±„íŒ… ì˜ì—­ */
      .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
      }

      .empty-state {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
      }

      .chat-header {
        padding: 20px;
        border-bottom: 1px solid #ddd;
        font-weight: bold;
        font-size: 18px;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #fafafa;
      }

      .message {
        margin-bottom: 15px;
      }

      .message-user {
        font-weight: bold;
        color: #007bff;
        margin-bottom: 5px;
      }

      .message-text {
        background: white;
        padding: 10px 15px;
        border-radius: 8px;
        display: inline-block;
      }

      .input-area {
        padding: 15px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
      }

      .input-area input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
      }

      .input-area button {
        padding: 12px 25px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      /* ëª¨ë‹¬ */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-box {
        background: white;
        padding: 30px;
        border-radius: 12px;
        width: 350px;
      }

      .modal-box h2 {
        margin-bottom: 20px;
      }

      .modal-box input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      .modal-buttons {
        display: flex;
        gap: 10px;
      }

      .modal-buttons button {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      .modal-buttons button:first-child {
        background: #ddd;
      }

      .modal-buttons button:last-child {
        background: #007bff;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- ì‚¬ì´ë“œë°” -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h1>ğŸ’¬ ì±„íŒ…</h1>
          <button id="btnCreate">+ ë°© ë§Œë“¤ê¸°</button>
        </div>
        <div class="room-list" id="roomList"></div>
      </div>

      <!-- ì±„íŒ… ì˜ì—­ -->
      <div class="chat-area" id="chatArea">
        <div class="empty-state">ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</div>
      </div>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div class="modal" id="modal">
      <div class="modal-box">
        <h2>ìƒˆ ì±„íŒ…ë°©</h2>
        <input type="text" id="roomName" placeholder="ë°© ì´ë¦„" />
        <div class="modal-buttons">
          <button id="btnCancel">ì·¨ì†Œ</button>
          <button id="btnSubmit">ìƒì„±</button>
        </div>
      </div>
    </div>

    <script>
      const API = "http://localhost:8080";

      let rooms = [];
      let currentRoom = null;
      let ws = null;
      const userId = `user_${Math.random().toString(36).substring(2, 9)}`;

      // DOM
      const roomList = document.getElementById("roomList");
      const chatArea = document.getElementById("chatArea");
      const modal = document.getElementById("modal");
      const roomNameInput = document.getElementById("roomName");

      // ì´ë²¤íŠ¸
      document.getElementById("btnCreate").onclick = () =>
        modal.classList.add("show");
      document.getElementById("btnCancel").onclick = () =>
        modal.classList.remove("show");
      document.getElementById("btnSubmit").onclick = createRoom;

      // ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
      async function loadRooms() {
        try {
          const res = await fetch(`${API}/rooms`);

          // ì‘ë‹µ ìƒíƒœ í™•ì¸
          if (!res.ok) {
            console.error(`Error: ${res.status}`);
            return;
          }

          rooms = await res.json();
          console.log("Rooms:", rooms);
          renderRooms();
        } catch (e) {
          console.error("loadRooms error:", e);
        }
      }

      // ì±„íŒ…ë°© ëª©ë¡ ë Œë”ë§
      function renderRooms() {
        // roomsê°€ ë°°ì—´ì¸ì§€ í™•ì¸
        if (!Array.isArray(rooms)) {
          console.error("rooms is not an array:", rooms);
          rooms = [];
          return;
        }

        roomList.innerHTML = rooms
          .map(
            (room) => `
      <div class="room-item ${currentRoom?.id === room.id ? "active" : ""}" 
           onclick="selectRoom('${room.id}')">
          ${room.name}
      </div>
  `
          )
          .join("");
      }

      // ì±„íŒ…ë°© ìƒì„±
      async function createRoom() {
        const name = roomNameInput.value.trim();
        if (!name) return alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");

        try {
          const res = await fetch(`${API}/rooms`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name }),
          });

          // ì‘ë‹µ ìƒíƒœ í™•ì¸
          if (!res.ok) {
            const error = await res.json();
            alert(`Error: ${error.error}`);
            return;
          }

          const newRoom = await res.json();

          // roomsê°€ ë°°ì—´ì¸ì§€ í™•ì¸
          if (!Array.isArray(rooms)) {
            rooms = [];
          }

          rooms.push(newRoom);

          roomNameInput.value = "";
          modal.classList.remove("show");
          renderRooms();
          selectRoom(newRoom.id);
        } catch (e) {
          console.error("createRoom error:", e);
          alert("ë°© ìƒì„± ì‹¤íŒ¨");
        }
      }

      // ì±„íŒ…ë°© ì„ íƒ
      async function selectRoom(roomId) {
        currentRoom = rooms.find((r) => r.id === roomId);
        if (!currentRoom) {
          console.error("Room not found:", roomId);
          return;
        }

        renderRooms();
        renderChat();
        await connectRoom(roomId);
      }

      // ì±„íŒ… ì˜ì—­ ë Œë”ë§
      function renderChat() {
        chatArea.innerHTML = `
    <div class="chat-header">${currentRoom.name}</div>
    <div class="messages" id="messages"></div>
    <div class="input-area">
        <input type="text" id="msgInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." 
               onkeypress="if(event.key==='Enter')sendMessage()">
        <button onclick="sendMessage()">ì „ì†¡</button>
    </div>
  `;
      }

      async function connectRoom(roomId) {
        console.log(`ğŸ”Œ [CONNECT] Connecting to room: ${roomId}`);
        if (ws) {
          ws.close();
          ws = null;
        }

        ws = new WebSocket(`ws://localhost:8080/ws/${roomId}/${userId}`);

        ws.onopen = () => {
          console.log(`âœ… [CONNECT] WebSocket opened for room: ${roomId}`);
          const container = document.getElementById("messages");
          if (container) container.innerHTML = "";
          // ì—°ê²° í›„ ê¸°ì¡´ ë©”ì‹œì§€ ë¡œë“œ
          loadMessages();
        };

        ws.onmessage = (event) => {
          console.log(`ğŸ“¨ [WS MESSAGE] Received:`, event.data);
          const data = JSON.parse(event.data);
          console.log(`ğŸ“¨ [WS MESSAGE] Parsed:`, data);
          if (data.type === "message") {
            console.log(
              `ğŸ’¬ [WS MESSAGE] Adding message from ${data.user}: ${data.message}`
            );
            addMessage(data.user, data.message);
          } else if (data.type === "user_joined") {
            addSystemMessage(data.message);
          } else if (data.type === "user_left") {
            addSystemMessage(data.message);
          }
        };

        ws.onerror = (error) => {
          console.error("WebSocket error:", error);
        };

        ws.onclose = () => {
          console.log("WebSocket closed");
        };
      }

      // ë©”ì‹œì§€ ë¡œë“œ
      async function loadMessages() {
        console.log(`ğŸ“¥ [LOAD] Loading messages for room: ${currentRoom.id}`);
        try {
          const res = await fetch(`${API}/rooms/${currentRoom.id}/messages`);

          if (!res.ok) {
            console.error(`âŒ [LOAD] Error: ${res.status}`);
            return;
          }

          const messages = await res.json();
          console.log(
            `ğŸ“¥ [LOAD] Received ${messages.length} messages:`,
            messages
          );

          const container = document.getElementById("messages");

          // messagesê°€ ë°°ì—´ì¸ì§€ í™•ì¸
          if (!Array.isArray(messages)) {
            console.error("âŒ [LOAD] messages is not an array:", messages);
            container.innerHTML = "<p>ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨</p>";
            return;
          }

          if (messages.length === 0) {
            console.log(`â„¹ï¸ [LOAD] No messages to display`);
            return;
          }

          console.log(`ğŸ“¥ [LOAD] Rendering ${messages.length} messages`);
          // ì„œë²„ì—ì„œ ìµœì‹ â†’ì˜¤ë˜ëœ ìˆœìœ¼ë¡œ ì˜¤ë¯€ë¡œ reverse
          messages.reverse();
          container.innerHTML = messages
            .map(
              (msg) => `
        <div class="message">
            <div class="message-user">${msg.user}</div>
            <div class="message-text">${msg.message}</div>
        </div>
    `
            )
            .join("");

          container.scrollTop = container.scrollHeight;
          console.log(`âœ… [LOAD] Messages rendered successfully`);
        } catch (e) {
          console.error("âŒ [LOAD] loadMessages error:", e);
        }
      }

      function addMessage(user, message) {
        const container = document.getElementById("messages");
        if (!container) return;
        container.insertAdjacentHTML(
          "beforeend",
          `
        <div class="message">
            <div class="message-user">${user}</div>
            <div class="message-text">${message}</div>
        </div>`
        );
        container.scrollTop = container.scrollHeight;
      }

      function addSystemMessage(text) {
        const container = document.getElementById("messages");
        if (!container) return;
        container.insertAdjacentHTML(
          "beforeend",
          `
        <div class="message">
            <div class="message-user" style="color:#555;">ì‹œìŠ¤í…œ</div>
            <div class="message-text">${text}</div>
        </div>`
        );
        container.scrollTop = container.scrollHeight;
      }

      // ë©”ì‹œì§€ ì „ì†¡
      async function sendMessage() {
        const input = document.getElementById("msgInput");
        const message = input.value.trim();
        if (!message) return;
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          alert("ì›¹ì†Œì¼“ ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤. ë°©ì„ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.");
          return;
        }

        console.log(`ğŸ“¤ [SEND] Sending message: ${message}`);
        ws.send(
          JSON.stringify({
            type: "message",
            message: message,
          })
        );
        console.log(`ğŸ“¤ [SEND] Message sent`);

        input.value = "";
      }

      loadRooms();
    </script>
  </body>
</html>
